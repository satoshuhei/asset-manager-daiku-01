{% extends "account_requests/base.html" %}
{% block title %}ライセンスプール{% endblock %}
{% block content %}
<h1 class="h3 mb-3">ライセンスプール</h1>
{% if error_message %}<div class="alert alert-danger py-2">{{ error_message }}</div>{% endif %}

<div class="card shadow-sm border-0 mb-4">
    <div class="card-header bg-white"><strong>プール登録</strong></div>
    <div class="card-body">
        <form method="post" class="row g-3 align-items-end">
            {% csrf_token %}
            <input type="hidden" name="action" value="create_pool">
            <div class="col-md-4"><label class="form-label">ライセンス名</label><input class="form-control" type="text" name="license_name" required></div>
            <div class="col-md-2"><label class="form-label">総数</label><input class="form-control" type="number" name="total_count" min="0" required></div>
            <div class="col-md-2"><label class="form-label">使用数</label><input class="form-control" type="number" name="used_count" min="0" value="0"></div>
            <div class="col-md-2"><label class="form-label">契約期限</label><input class="form-control" type="date" name="contract_expiry_date"></div>
            <div class="col-md-2 text-end"><button class="btn btn-primary" type="submit">登録</button></div>
        </form>
    </div>
</div>

<div class="card shadow-sm border-0 mb-4">
    <div class="card-header bg-white"><strong>プール一覧</strong></div>
    <div class="table-responsive">
        <table class="table table-striped table-hover mb-0 align-middle">
            <thead class="table-light"><tr><th>ID</th><th>ライセンス名</th><th>総数</th><th>使用数</th><th>残数</th><th>割当表示</th></tr></thead>
            <tbody>
            {% for pool in pools %}
                <tr>
                    <td>{{ pool.id }}</td>
                    <td>{{ pool.license_name }}</td>
                    <td>{{ pool.total_count }}</td>
                    <td>{{ pool.used_count }}</td>
                    <td>{{ pool.remaining_count }}</td>
                    <td><a class="btn btn-sm btn-outline-primary" href="/license-pools?pool_id={{ pool.id }}">表示</a></td>
                </tr>
            {% empty %}
                <tr><td colspan="6" class="text-center text-muted py-4">データがありません</td></tr>
            {% endfor %}
            </tbody>
        </table>
    </div>
</div>

{% if selected_pool_id %}
<div class="card shadow-sm border-0 mb-3">
    <div class="card-header bg-white"><strong>割当登録（プールID: {{ selected_pool_id }}）</strong></div>
    <div class="card-body">
        <form method="post" class="row g-3 align-items-end">
            {% csrf_token %}
            <input type="hidden" name="action" value="allocate">
            <input type="hidden" name="pool_id" value="{{ selected_pool_id }}">
            <div class="col-md-8">
                <label class="form-label">資産</label>
                <select class="form-select" name="asset_id" required>
                    {% for asset in assets %}
                    <option value="{{ asset.id }}">{{ asset.asset_code }} / {{ asset.asset_name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-2"><label class="form-label">割当数</label><input class="form-control" type="number" name="allocated_count" min="1" value="1"></div>
            <div class="col-md-2 text-end"><button class="btn btn-primary" type="submit">割当</button></div>
        </form>
    </div>
</div>

<div class="card shadow-sm border-0">
    <div class="card-header bg-white"><strong>割当履歴</strong></div>
    <div class="table-responsive">
        <table class="table table-striped table-hover mb-0 align-middle">
            <thead class="table-light"><tr><th>ID</th><th>資産ID</th><th>割当数</th><th>割当日時</th></tr></thead>
            <tbody>
            {% for item in allocations %}
                <tr>
                    <td>{{ item.id }}</td>
                    <td>{{ item.asset_id }}</td>
                    <td>{{ item.allocated_count }}</td>
                    <td>{{ item.allocated_at }}</td>
                </tr>
            {% empty %}
                <tr><td colspan="4" class="text-center text-muted py-4">データがありません</td></tr>
            {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endif %}
{% endblock %}
