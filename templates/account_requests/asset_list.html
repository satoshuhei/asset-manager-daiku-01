{% extends "account_requests/base.html" %}
{% block title %}資産一覧{% endblock %}
{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
    <h1 class="h3 mb-0">資産一覧</h1>
</div>

{% if error_message %}<div class="alert alert-danger py-2">{{ error_message }}</div>{% endif %}
{% if create_error_message %}<div class="alert alert-danger py-2">{{ create_error_message }}</div>{% endif %}

<div class="card shadow-sm border-0 mb-4">
    <div class="card-header bg-white"><strong>資産登録</strong></div>
    <div class="card-body">
        <form method="post" class="row g-3">
            {% csrf_token %}
            <input type="hidden" name="action" value="create_asset">

            <div class="col-md-3">
                <label class="form-label">資産コード</label>
                <input type="text" class="form-control" name="asset_code" value="{{ create_form.asset_code|default:'' }}" required>
            </div>
            <div class="col-md-4">
                <label class="form-label">資産名</label>
                <input type="text" class="form-control" name="asset_name" value="{{ create_form.asset_name|default:'' }}" required>
            </div>
            <div class="col-md-2">
                <label class="form-label">資産種別</label>
                <select class="form-select" name="asset_type_id" required>
                    <option value="">--</option>
                    {% for t in asset_type_options %}
                    <option value="{{ t.id }}" {% if create_form.asset_type_id == t.id|stringformat:"s" %}selected{% endif %}>{{ t.code }}:{{ t.name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-3">
                <label class="form-label">小分類</label>
                <select class="form-select" name="category_s_id" required>
                    <option value="">--</option>
                    {% for category_s in category_s_options %}
                    <option value="{{ category_s.id }}" {% if create_form.category_s_id == category_s.id|stringformat:"s" %}selected{% endif %}>
                        {{ category_s.category_m.category_l.name }} / {{ category_s.category_m.name }} / {{ category_s.name }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-3">
                <label class="form-label">資産区分</label>
                <select class="form-select" name="asset_kind" required>
                    {% for value, label in asset_kind_options %}
                    <option value="{{ value }}" {% if create_form.asset_kind == value %}selected{% endif %}>{{ label }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-3">
                <label class="form-label">状態</label>
                <select class="form-select" name="status">
                    {% for value, label in status_options %}
                    <option value="{{ value }}" {% if create_form.status == value %}selected{% endif %}>{{ label }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-3">
                <label class="form-label">AS-A-006 利用者</label>
                <select class="form-select" name="person_attr_01">
                    <option value="">--</option>
                    {% for person in person_options %}
                    <option value="{{ person.id }}" {% if create_form.person_attr_01 == person.id|stringformat:"s" %}selected{% endif %}>{{ person.username }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-3">
                <label class="form-label">AS-A-007 管理責任者</label>
                <select class="form-select" name="person_attr_02" required>
                    <option value="">--</option>
                    {% for person in person_options %}
                    <option value="{{ person.id }}" {% if create_form.person_attr_02 == person.id|stringformat:"s" %}selected{% endif %}>{{ person.username }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-3">
                <label class="form-label">AS-A-008 最終更新者</label>
                <select class="form-select" name="person_attr_03">
                    <option value="">--</option>
                    {% for person in person_options %}
                    <option value="{{ person.id }}" {% if create_form.person_attr_03 == person.id|stringformat:"s" %}selected{% endif %}>{{ person.username }}</option>
                    {% endfor %}
                </select>
            </div>

            <div class="col-12"><hr class="my-1"></div>
            <div class="col-12"><strong class="small text-muted">属性20</strong></div>

            <div class="col-md-4"><label class="form-label">AS-A-001</label><input type="text" class="form-control" name="cls_attr_01" value="{{ create_form.cls_attr_01|default:'' }}"></div>
            <div class="col-md-4"><label class="form-label">AS-A-002</label><input type="text" class="form-control" name="cls_attr_02" value="{{ create_form.cls_attr_02|default:'' }}"></div>
            <div class="col-md-4"><label class="form-label">AS-A-003</label><input type="text" class="form-control" name="cls_attr_03" value="{{ create_form.cls_attr_03|default:'' }}"></div>
            <div class="col-md-4"><label class="form-label">AS-A-004</label><input type="text" class="form-control" name="cls_attr_04" value="{{ create_form.cls_attr_04|default:'' }}"></div>
            <div class="col-md-4"><label class="form-label">AS-A-005</label><input type="text" class="form-control" name="cls_attr_05" value="{{ create_form.cls_attr_05|default:'' }}"></div>
            <div class="col-md-4"><label class="form-label">AS-A-009</label><input type="text" class="form-control" name="location_attr_01" value="{{ create_form.location_attr_01|default:'' }}"></div>
            <div class="col-md-4"><label class="form-label">AS-A-010</label><input type="text" class="form-control" name="location_attr_02" value="{{ create_form.location_attr_02|default:'' }}"></div>
            <div class="col-md-4"><label class="form-label">AS-A-011</label><input type="date" class="form-control" name="date_attr_01" value="{{ create_form.date_attr_01|default:'' }}"></div>
            <div class="col-md-4"><label class="form-label">AS-A-012</label><input type="date" class="form-control" name="date_attr_02" value="{{ create_form.date_attr_02|default:'' }}"></div>
            <div class="col-md-4"><label class="form-label">AS-A-013</label><input type="date" class="form-control" name="date_attr_03" value="{{ create_form.date_attr_03|default:'' }}"></div>
            <div class="col-md-4"><label class="form-label">AS-A-014</label><input type="text" class="form-control" name="free_text_attr_01" value="{{ create_form.free_text_attr_01|default:'' }}"></div>
            <div class="col-md-4"><label class="form-label">AS-A-015</label><input type="text" class="form-control" name="free_text_attr_02" value="{{ create_form.free_text_attr_02|default:'' }}"></div>
            <div class="col-md-4"><label class="form-label">AS-A-016</label><input type="text" class="form-control" name="free_text_attr_03" value="{{ create_form.free_text_attr_03|default:'' }}"></div>
            <div class="col-md-6"><label class="form-label">AS-A-019</label><textarea class="form-control" name="memo_attr_01" rows="2">{{ create_form.memo_attr_01|default:'' }}</textarea></div>
            <div class="col-md-6"><label class="form-label">AS-A-020</label><textarea class="form-control" name="memo_attr_02" rows="2">{{ create_form.memo_attr_02|default:'' }}</textarea></div>

            <div class="col-12"><strong class="small text-muted">1:n属性</strong></div>
            <div class="col-md-6"><label class="form-label">AS-A-017 multi_attr_01（1行1件）</label><textarea class="form-control" name="multi_attr_01_lines" rows="3">{{ create_form.multi_attr_01_lines|default:'' }}</textarea></div>
            <div class="col-md-6"><label class="form-label">AS-A-018 multi_attr_02（1行1件）</label><textarea class="form-control" name="multi_attr_02_lines" rows="3">{{ create_form.multi_attr_02_lines|default:'' }}</textarea></div>

            <div class="col-12 text-end">
                <button type="submit" class="btn btn-primary">資産登録</button>
            </div>
        </form>
    </div>
</div>

<div class="card shadow-sm border-0 mb-4">
    <div class="card-header bg-white"><strong>検索</strong></div>
    <div class="card-body">
        <form method="get" class="row g-3 align-items-end">
            <div class="col-md-2">
                <label class="form-label">資産コード</label>
                <input type="text" class="form-control" name="asset_code" value="{{ search.asset_code }}">
            </div>
            <div class="col-md-2">
                <label class="form-label">資産名</label>
                <input type="text" class="form-control" name="asset_name" value="{{ search.asset_name }}">
            </div>
            <div class="col-md-3">
                <label class="form-label">小分類</label>
                <select class="form-select" name="category_s_id">
                    <option value="">--</option>
                    {% for category_s in category_s_options %}
                    <option value="{{ category_s.id }}" {% if search.category_s_id == category_s.id|stringformat:"s" %}selected{% endif %}>
                        {{ category_s.category_m.category_l.name }} / {{ category_s.category_m.name }} / {{ category_s.name }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-2">
                <label class="form-label">予算紐付け状態</label>
                <select class="form-select" name="budget_link_status">
                    <option value="">--</option>
                    {% for value, label in budget_link_options %}
                    <option value="{{ value }}" {% if search.budget_link_status == value %}selected{% endif %}>{{ label }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-3">
                <label class="form-label">利用者</label>
                <select class="form-select" name="person_attr_01_id">
                    <option value="">--</option>
                    {% for person in person_options %}
                    <option value="{{ person.id }}" {% if search.person_attr_01_id == person.id|stringformat:"s" %}selected{% endif %}>{{ person.username }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-6">
                <label class="form-label">ステータス（複数選択）</label>
                <select class="form-select" name="status" multiple size="4">
                    {% for status_code, status_label in status_options %}
                    <option value="{{ status_code }}" {% if status_code in search.status %}selected{% endif %}>{{ status_label }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-12 text-end">
                <button type="submit" class="btn btn-outline-primary">検索</button>
            </div>
        </form>
    </div>
</div>

<div class="card shadow-sm border-0">
    <div class="card-header bg-white"><strong>資産データ</strong></div>
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-hover table-striped align-middle mb-0">
                <thead class="table-light">
                    <tr>
                        <th>ID</th>
                        <th>資産コード</th>
                        <th>資産名</th>
                        <th>分類（大/中/小）</th>
                        <th>状態</th>
                        <th>予算紐付け</th>
                        <th>利用者</th>
                        <th>期限日</th>
                        <th>状態遷移</th>
                    </tr>
                </thead>
                <tbody>
                    {% for asset in assets %}
                    <tr>
                        <td>{{ asset.id }}</td>
                        <td><a href="/assets/{{ asset.id }}">{{ asset.asset_code }}</a></td>
                        <td>{{ asset.asset_name }}</td>
                        <td>{{ asset.category_s.category_m.category_l.name }} / {{ asset.category_s.category_m.name }} / {{ asset.category_s.name }}</td>
                        <td><span class="badge text-bg-secondary">{{ asset.status }}</span></td>
                        <td>{{ asset.budget_link_status }}</td>
                        <td>{% if asset.display_person_attr_01 %}{{ asset.display_person_attr_01.username }}{% else %}-{% endif %}</td>
                        <td>{% if asset.display_date_attr_03 %}{{ asset.display_date_attr_03|date:"Y-m-d" }}{% else %}-{% endif %}</td>
                        <td>
                            {% if asset.available_next_statuses %}
                            <form method="post" class="d-flex gap-2">
                                {% csrf_token %}
                                <input type="hidden" name="asset_id" value="{{ asset.id }}">
                                <select class="form-select form-select-sm" name="new_status" required>
                                    {% for status in asset.available_next_statuses %}
                                    <option value="{{ status.status_code }}">{{ status.status_name }}</option>
                                    {% endfor %}
                                </select>
                                <button type="submit" class="btn btn-sm btn-outline-primary">遷移</button>
                            </form>
                            {% else %}
                            <span class="text-muted small">遷移候補なし</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% empty %}
                    <tr><td colspan="9" class="text-center text-muted py-4">データがありません</td></tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}