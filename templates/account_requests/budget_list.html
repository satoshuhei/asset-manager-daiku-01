{% extends "account_requests/base.html" %}
{% block title %}予算/執行済予算{% endblock %}
{% block content %}
<h1 class="h3 mb-3">予算/執行済予算</h1>
{% if error_message %}<div class="alert alert-danger py-2">{{ error_message }}</div>{% endif %}

<div class="card shadow-sm border-0 mb-4">
    <div class="card-header bg-white"><strong>予算登録</strong></div>
    <div class="card-body">
        <form method="post" class="row g-3">
            {% csrf_token %}
            <input type="hidden" name="action" value="create_budget">
            <div class="col-md-2"><label class="form-label">年度</label><input class="form-control" type="number" name="fiscal_year" required></div>
            <div class="col-md-2"><label class="form-label">予算科目</label><input class="form-control" type="text" name="budget_category" required></div>
            <div class="col-md-4">
                <label class="form-label">予算小分類</label>
                <select class="form-select" name="budget_category_s_id" required>
                    <option value="">選択してください</option>
                    {% for category_s in budget_categories_s %}
                    <option value="{{ category_s.id }}">{{ category_s.category_m.category_l.name }} / {{ category_s.category_m.name }} / {{ category_s.name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-2"><label class="form-label">プロジェクトID</label><input class="form-control" type="number" name="project_id" required></div>
            <div class="col-md-2"><label class="form-label">予算額</label><input class="form-control" type="number" step="0.01" name="planned_amount" required></div>

            <div class="col-12"><strong class="small text-muted">予算属性20</strong></div>
            {% for index in budget_attr_indices %}
            <div class="col-md-3"><label class="form-label">attr_{{ index|stringformat:"02d" }}</label><input class="form-control" type="text" name="attr_{{ index|stringformat:"02d" }}"></div>
            {% endfor %}

            <div class="col-12"><strong class="small text-muted">1:n情報（MULTI_01 / MULTI_02）</strong></div>
            <div class="col-md-4"><label class="form-label">MULTI_01 値</label><input class="form-control" type="text" name="multi_multi_01_value" maxlength="500"></div>
            <div class="col-md-2"><label class="form-label">MULTI_01 表示順</label><input class="form-control" type="number" name="multi_multi_01_sort" value="1"></div>
            <div class="col-md-4"><label class="form-label">MULTI_02 値</label><input class="form-control" type="text" name="multi_multi_02_value" maxlength="500"></div>
            <div class="col-md-2"><label class="form-label">MULTI_02 表示順</label><input class="form-control" type="number" name="multi_multi_02_sort" value="1"></div>

            <div class="col-12 text-end"><button class="btn btn-primary" type="submit">予算登録</button></div>
        </form>
    </div>
</div>

<div class="card shadow-sm border-0 mb-4">
    <div class="card-header bg-white"><strong>予算一覧</strong></div>
    <div class="table-responsive">
        <table class="table table-striped table-hover mb-0 align-middle">
            <thead class="table-light"><tr><th>ID</th><th>年度</th><th>科目</th><th>プロジェクトID</th><th>予算額</th><th>実績表示</th></tr></thead>
            <tbody>
            {% for budget in budgets %}
                <tr>
                    <td>{{ budget.id }}</td>
                    <td>{{ budget.fiscal_year }}</td>
                    <td>{{ budget.budget_category }}</td>
                    <td>{{ budget.project_id }}</td>
                    <td>{{ budget.planned_amount }}</td>
                    <td><a class="btn btn-sm btn-outline-primary" href="/budgets?budget_id={{ budget.id }}">表示</a></td>
                </tr>
            {% empty %}
                <tr><td colspan="6" class="text-center text-muted py-4">データがありません</td></tr>
            {% endfor %}
            </tbody>
        </table>
    </div>
</div>

{% if selected_budget %}
<div class="card shadow-sm border-0 mb-3">
    <div class="card-header bg-white"><strong>執行済予算登録（予算ID: {{ selected_budget.id }}）</strong></div>
    <div class="card-body">
        <form method="post" class="row g-3 align-items-end">
            {% csrf_token %}
            <input type="hidden" name="action" value="create_execution">
            <input type="hidden" name="budget_id" value="{{ selected_budget.id }}">
            <div class="col-md-3"><label class="form-label">執行日</label><input class="form-control" type="date" name="executed_date" required></div>
            <div class="col-md-3"><label class="form-label">執行額</label><input class="form-control" type="number" step="0.01" name="executed_amount" required></div>
            <div class="col-md-4"><label class="form-label">説明</label><input class="form-control" type="text" name="description"></div>
            <div class="col-md-2 text-end"><button class="btn btn-primary" type="submit">執行登録</button></div>
        </form>
    </div>
</div>

<div class="card shadow-sm border-0">
    <div class="card-header bg-white"><strong>執行済予算一覧</strong></div>
    <div class="table-responsive">
        <table class="table table-striped table-hover mb-0 align-middle">
            <thead class="table-light"><tr><th>ID</th><th>執行日</th><th>執行額</th><th>説明</th></tr></thead>
            <tbody>
            {% for item in executions %}
                <tr>
                    <td>{{ item.id }}</td>
                    <td>{{ item.executed_date }}</td>
                    <td>{{ item.executed_amount }}</td>
                    <td>{{ item.description }}</td>
                </tr>
            {% empty %}
                <tr><td colspan="4" class="text-center text-muted py-4">データがありません</td></tr>
            {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endif %}
{% endblock %}
