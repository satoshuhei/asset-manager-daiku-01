# 資産管理システム 詳細設計書（バッチ）

## 0. 文書情報
- 文書名: 資産管理システム 詳細設計書（バッチ）
- 版数: v0.1（ドラフト）
- 作成日: 2026-02-17
- 参照: `docs/02_要件定義書.md`, `docs/03_基本設計書.md`

## 1. 方針
- 日次・月次の監視/通知をバッチで実行する
- バッチ本体は Application Service から実行し、Domain 更新はサービス経由のみ
- 通知対象抽出はDB評価で実施し、全件実体化を避ける

## 2. バッチ一覧
| バッチID | 名称 | 実行頻度 | 主目的 |
|---|---|---|---|
| BAT-001 | 保守期限通知バッチ | 日次（06:00） | 期限切れ/期限間近の通知 |
| BAT-002 | 未紐付け資産監視バッチ | 日次（06:30） | 予算未紐付け資産の可視化 |
| BAT-003 | KPI集計バッチ | 日次（07:00） | ダッシュボード用集計更新 |
| BAT-004 | 月次棚卸対象生成バッチ | 月次（1日 02:00） | 棚卸対象スナップショット生成 |

## 3. BAT-001 保守期限通知バッチ
### 3.1 入力
- `asset`, `maintenance_contract`, `asset_attribute_value`

### 3.2 判定
- 期限切れ: `contract_end_date < current_date`
- 期限間近: `current_date <= contract_end_date <= current_date + 30日`

### 3.3 出力
- 通知キューへ登録（`notification_queue`）
- 監査ログへ件数記録（`audit_log`）

### 3.4 例外
- 契約未設定資産は対象外（警告ログのみ）

## 4. BAT-002 未紐付け資産監視バッチ
### 4.1 入力
- `asset`（`budget_link_status='UNLINKED'`）

### 4.2 処理
1. 未紐付け資産を部門別・分類別に集計
2. 閾値超過部門を抽出
3. 通知データを生成

### 4.3 出力
- 監視結果テーブル更新（`asset_budget_monitor_daily`）
- 管理者向け通知（`notification_queue`）

## 5. BAT-003 KPI集計バッチ
### 5.1 集計項目
- 予算消化率
- 未紐付け資産件数
- 保守更新漏れ件数
- 棚卸差異件数
- 構成情報完全率

### 5.2 出力
- ダッシュボード集計テーブル（`dashboard_kpi_daily`）

## 6. BAT-004 月次棚卸対象生成バッチ
### 6.1 処理
1. 当月対象資産を抽出
2. 棚卸対象スナップショットを作成
3. 棚卸回マスタへ紐付け

### 6.3 入出力テーブル
- 入力: `inventory_cycle`, `asset`
- 出力: `inventory_target_snapshot`

### 6.2 整合性
- 廃棄済資産は対象外
- 対象重複を禁止

## 7. 共通エラー処理
- 失敗時は処理単位でロールバック
- 失敗件数と原因を監査ログへ記録
- 再実行時は冪等性を担保（同一キーの重複登録防止）

## 8. 運用監視
- 実行結果（成功/失敗/件数/実行時間）を日次レポート化
- 連続失敗3回で管理者アラート
