# 資産管理システム 基本設計書

## 0. 文書情報
- 文書名: 資産管理システム 基本設計書
- 版数: v1.1（ドラフト）
- 作成日: 2026-02-17
- 対応要件: `docs/02_要件定義書.md`

## 1. 設計方針
- Django の3層（Interface/Application/Domain）を採用する
- `View` は薄く保ち、業務ロジックは `Service` に集約する
- 状態遷移は `workflow_service` 経由のみ許可する
- 資産は有形/無形を `asset` で統一管理し、分類/属性で差分を吸収する
- 予算紐付けは任意（後付け可能）で設計する
- 認証は Django 標準認証を利用し、業務画面はログイン必須とする
- ユーザ管理（登録/無効化）は Django 管理画面のみで実施する

## 2. システム構成（論理）
### 2.1 レイヤ構成
- Interface: `views.py`, `forms.py`, `templates/`, `urls.py`
- Application: `apps/account_requests/services/*.py`
- Domain/Persistence: `models.py`, QuerySet/Manager, migrations

### 2.3 認証/ユーザ管理構成
- 認証: Django Session Authentication
- ユーザ情報: Django 標準 `auth_user` を利用
- ユーザ登録/変更: Django 管理画面（`/admin`）でシステム管理者が実施
- 業務画面/API: ユーザ自己登録機能を提供しない

### 2.2 主要モジュール
- 資産管理モジュール
- 構成管理モジュール
- 予算/執行済予算モジュール
- ライセンス管理モジュール
- 利用/貸出管理モジュール
- PC管理モジュール
- 棚卸/廃棄モジュール

## 3. 画面基本設計
### 3.1 画面一覧
- ダッシュボード
- 資産一覧
- 資産詳細/編集
- 構成ビュー
- 予算/執行済予算ビュー
- ライセンスプール
- PC管理
- 棚卸

### 3.2 画面遷移
- 参照: `docs/04_画面遷移図.md`
- 画面遷移の起点はダッシュボードとする
- 資産詳細を編集ハブ画面とする

### 3.3 画面共通仕様
- 一覧はDB評価で検索/絞り込み/ソート/ページングを実施する
- 未紐付け資産フィルタを全主要一覧で提供する
- CSV出力は検索条件を引き継いで出力する

### 3.4 機能と画面の対応
| 機能ID | 機能 | 対応画面ID | 対応画面 |
|---|---|---|---|
| F-00 | 認証/ユーザ管理 | SCR-000 | ログイン |
| F-01 | ダッシュボード可視化 | SCR-001 | ダッシュボード |
| F-02 | 資産管理 | SCR-010, SCR-011 | 資産一覧, 資産詳細/編集 |
| F-03 | 構成管理 | SCR-020 | 構成ビュー |
| F-04 | 予算/執行済予算管理 | SCR-030 | 予算/執行済予算 |
| F-05 | ライセンス管理 | SCR-040 | ライセンスプール |
| F-06 | PC管理 | SCR-050 | PC管理 |
| F-07 | 棚卸管理 | SCR-060 | 棚卸 |
| F-08 | 廃棄承認 | SCR-070 | 廃棄承認 |
| F-09 | 監査ログ閲覧 | SCR-080 | 監査ログ閲覧 |

## 4. データ基本設計
### 4.1 エンティティ構成
- 参照: `docs/05_ER図案.md`
- 中核エンティティ: `asset`, `configuration`, `budget`, `executed_budget`
- 分類マスタ: `asset_category_l_mst`, `asset_category_m_mst`, `asset_category_s_mst`
- 属性: `asset_attribute_value`（単一値）/`asset_attribute_multi_value`（1:n値）

### 4.2 キー・制約方針
- `asset.asset_code` は一意
- `asset.budget_id` は NULL 許容
- `asset.category_s_id` は必須
- 廃棄済資産は構成明細へ追加不可
- ライセンス使用数は総数を超過不可

### 4.3 監査・履歴方針
- 主要更新は監査ログへ記録する（誰が/いつ/何を）
- 構成変更、予算紐付け変更、廃棄処理は履歴テーブルで追跡可能にする

## 5. 業務処理基本設計
### 5.1 資産登録処理
1. 入力検証（Form）
2. 分類階層の整合性確認
3. `asset` 登録
4. 属性20を `asset_attribute_value` / `asset_attribute_multi_value` に保存
5. 監査ログ記録

### 5.2 予算後付け紐付け処理
1. 資産の存在/状態確認
2. 予算/執行済予算の参照整合性確認
3. 紐付け更新（`budget_id`, `budget_link_status`）
4. 変更履歴・監査ログ記録

### 5.3 構成更新処理
1. 構成ヘッダ取得
2. 明細更新（追加/変更/削除）
3. 廃棄済資産の追加禁止バリデーション
4. 履歴記録

### 5.4 廃棄処理
1. 廃棄申請登録
2. 承認
3. 証跡登録（データ消去等）
4. 資産ステータス更新（workflow_service経由）

## 6. 入力バリデーション基本設計
- 日付整合: `date_attr_03 >= date_attr_01` を満たす
- 文字数制限: 自由テキスト/メモの上限を厳守
- 条件必須: PC資産は `person_attr_01` 必須
- 1:n属性: `multi_attr_02` は同一資産内重複不可

## 7. 権限設計（基本）
### 7.1 ロール
- 閲覧者
- 編集者
- 承認者
- 管理者

### 7.2 権限マトリクス（要約）
- 閲覧者: 閲覧のみ
- 編集者: 登録/更新（廃棄承認不可）
- 承認者: 廃棄承認、更新判断承認
- 管理者: 全操作 + マスタ管理

### 7.3 権限マトリクス（機能単位）
| 機能 | 閲覧者 | 編集者 | 承認者 | 管理者 |
|---|---|---|---|---|
| ログイン/ログアウト | ○ | ○ | ○ | ○ |
| 資産一覧/詳細閲覧 | ○ | ○ | ○ | ○ |
| 資産登録/更新 | - | ○ | ○ | ○ |
| 構成登録/更新 | - | ○ | ○ | ○ |
| 予算/執行済予算登録 | - | ○ | ○ | ○ |
| 予算後付け紐付け | - | ○ | ○ | ○ |
| ライセンス割当 | - | ○ | ○ | ○ |
| 棚卸差異登録/是正 | - | ○ | ○ | ○ |
| 廃棄申請 | - | ○ | ○ | ○ |
| 廃棄承認/差戻し | - | - | ○ | ○ |
| 監査ログ閲覧 | - | - | ○ | ○ |
| ユーザ登録/無効化（Django管理画面） | - | - | - | ○ |

## 8. 非機能設計（基本）
- パフォーマンス: 一覧系はDB評価優先、早期 `list()` 化を禁止
- 可用性: 重要更新はトランザクション制御
- 保守性: 業務ルールはServiceへ集約
- 拡張性: SAML/OIDC連携を見据えた認証境界を確保

## 9. テスト基本方針
- Service層の業務ロジックは正常系/異常系を必須
- 予算後付け、廃棄禁止条件、ライセンス上限を重点テスト
- 画面は主要導線の結合テストを実施

## 10. 移行・運用基本設計
- 既存Excelをステージングテーブルへ投入
- クレンジング後に本テーブルへ反映
- 未紐付け資産は運用タスクとして継続管理

## 11. 成果物連携
- 要件定義書: `docs/02_要件定義書.md`
- 画面遷移図: `docs/04_画面遷移図.md`
- ER案: `docs/05_ER図案.md`
- 画面項目定義: `docs/06_詳細設計_画面項目定義.md`
- API詳細: `docs/07_詳細設計_API設計.md`
- 論理DDL草案: `docs/08_詳細設計_論理DDL.sql`
- バッチ詳細: `docs/09_詳細設計_バッチ設計.md`
- CSVレイアウト詳細: `docs/10_詳細設計_CSVレイアウト.md`
- 運用手順: `docs/11_運用手順書_Runbook.md`
- UATチェックリスト: `docs/12_UATチェックリスト.md`
- 文書整合MECEチェック: `docs/13_文書整合MECEチェック記録.md`
- 移行項目マッピング: `docs/14_移行項目マッピング表.md`
- 帳票レイアウト定義: `docs/15_帳票レイアウト定義.md`
- 受入基準詳細: `docs/16_受入基準詳細_UAT観点定義.md`
- UAT実施記録: `docs/17_UAT実施記録.md`
