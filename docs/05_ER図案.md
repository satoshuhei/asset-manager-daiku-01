# 資産管理システム ER案（最小）

## 1. 方針
- 有形/無形を `asset` で統一管理し、種別で識別する。
- 分類は `大分類/中分類/小分類` の3階層で管理する。
- 構成は `configuration` と `configuration_item` の2層で表現する。
- 予算紐付けは任意とし、後付け更新を前提にする。
- 執行済予算は履歴（`executed_budget`）として保持する。
- 属性情報は20属性（個別分類5、人3、場所2、日付3、自由テキスト3、1:n情報2、メモ2）を保持する。

## 2. エンティティ一覧
- `asset`
- `asset_type_mst`
- `asset_category_l_mst`
- `asset_category_m_mst`
- `asset_category_s_mst`
- `configuration`
- `configuration_item`
- `license_pool`
- `license_allocation_history`
- `budget`
- `executed_budget`
- `project_mst`
- `vendor_mst`
- `maintenance_contract`
- `loan_history`
- `disposal_history`
- `user_pc_assignment`
- `asset_attribute_value`
- `asset_attribute_multi_value`

## 3. ER図（Mermaid）
```mermaid
erDiagram
    asset_type_mst ||--o{ asset : classifies
  asset_category_l_mst ||--o{ asset_category_m_mst : parent
  asset_category_m_mst ||--o{ asset_category_s_mst : parent
  asset_category_s_mst ||--o{ asset : classifies
    project_mst ||--o{ budget : owns
    budget ||--o{ executed_budget : has

    vendor_mst ||--o{ asset : supplies
    vendor_mst ||--o{ maintenance_contract : contracts

    asset ||--o{ configuration_item : included_in
    configuration ||--o{ configuration_item : contains

    license_pool ||--o{ license_allocation_history : records
    asset ||--o{ license_allocation_history : allocated_to

    asset ||--o{ loan_history : loaned
    asset ||--o| user_pc_assignment : assigned
    asset ||--o{ disposal_history : disposed
    asset ||--o| maintenance_contract : covered_by
    asset ||--o| asset_attribute_value : has_single
    asset ||--o{ asset_attribute_multi_value : has_multi

    budget o|--o{ asset : linked_optional

    asset {
      bigint id PK
      string asset_code
      bigint asset_type_id FK
      bigint category_s_id FK
      string asset_name
      string asset_kind
      string status
      bigint vendor_id FK
      bigint budget_id FK
      string budget_link_status
      date purchase_date
      date warranty_expiry_date
      datetime created_at
      datetime updated_at
    }

    asset_category_l_mst {
      bigint id PK
      string code
      string name
      boolean is_active
    }

    asset_category_m_mst {
      bigint id PK
      bigint category_l_id FK
      string code
      string name
      boolean is_active
    }

    asset_category_s_mst {
      bigint id PK
      bigint category_m_id FK
      string code
      string name
      boolean is_active
    }

    budget {
      bigint id PK
      int fiscal_year
      string budget_category
      bigint project_id FK
      decimal planned_amount
      datetime created_at
      datetime updated_at
    }

    executed_budget {
      bigint id PK
      bigint budget_id FK
      date executed_date
      decimal executed_amount
      string description
      datetime created_at
    }

    configuration {
      bigint id PK
      string config_code
      string config_name
      string status
      datetime created_at
      datetime updated_at
    }

    configuration_item {
      bigint id PK
      bigint configuration_id FK
      bigint asset_id FK
      string role_type
      int quantity
      datetime created_at
    }

    license_pool {
      bigint id PK
      string license_name
      int total_count
      int used_count
      int remaining_count
      date contract_expiry_date
      datetime created_at
      datetime updated_at
    }

    asset_attribute_value {
      bigint id PK
      bigint asset_id FK
      string cls_attr_01
      string cls_attr_02
      string cls_attr_03
      string cls_attr_04
      string cls_attr_05
      string person_attr_01
      string person_attr_02
      string person_attr_03
      string location_attr_01
      string location_attr_02
      date date_attr_01
      date date_attr_02
      date date_attr_03
      string free_text_attr_01
      string free_text_attr_02
      string free_text_attr_03
      text memo_attr_01
      text memo_attr_02
      datetime updated_at
    }

    asset_attribute_multi_value {
      bigint id PK
      bigint asset_id FK
      string multi_attr_type
      string value
      int sort_order
      datetime created_at
    }
```

## 4. 主要制約（最小）
- `asset.budget_id` は NULL 許容（予算未紐付け登録を許可）
- `asset.budget_link_status` は `未設定/設定済` を保持
- `asset.category_s_id` は必須（小分類まで必須入力）
- 廃棄済の `asset.status` は `configuration_item` への新規追加不可
- ライセンスは `total_count >= used_count` を満たす
- `asset_attribute_value.asset_id` は一意（資産ごとに単一値属性は1レコード）
- `asset_attribute_multi_value.multi_attr_type` は `MULTI_01/MULTI_02` のみ許容

## 5. 主要インデックス（最小）
- `asset(asset_code)` 一意
- `asset(status, budget_link_status, category_s_id)`
- `budget(fiscal_year, project_id)`
- `configuration_item(configuration_id, asset_id)`
- `license_allocation_history(asset_id)`
- `asset_attribute_multi_value(asset_id, multi_attr_type, sort_order)`

## 6. 補足
本ER案は概念/論理設計の初版であり、物理設計時に命名規約・正規化・監査項目を詳細化する。
