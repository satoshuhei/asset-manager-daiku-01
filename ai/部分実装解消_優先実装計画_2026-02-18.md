# 部分実装解消 優先実装計画（MVP順）

作成日: 2026-02-18  
入力: `ai/部分実装棚卸し_2026-02-18.md`

## 1. 目的
- 部分実装に留まっている機能/画面/項目を、業務停止リスクと規約適合性（3層責務分離）を優先して段階的に完了させる。
- まずは運用に直結する更新系（資産編集、廃棄承認、棚卸是正）をMVPとして完成させる。

## 2. 優先順位（結論）
1. **P1: 資産編集APIの完成化（Service化 + 属性20 + 1:n更新）**
2. **P2: 廃棄承認/棚卸の操作UI実装（承認・差戻し・差異是正）**
3. **P3: 予算画面の3階層/属性20/1:n入力対応**
4. **P4: 監査ログ検索UI + ダッシュボード不足指標（予算消化率/保守期限）**

## 3. 実装フェーズ

### フェーズ1（P1）: 資産編集APIの完成化
対象:
- API: `PUT /api/v1/assets/{asset_id}`
- 関連: `AssetAttributeValue`, `AssetAttributeMultiValue`

実装方針:
- View直更新を廃止し、`apps/account_requests/services` 配下に資産更新Serviceを新設/拡張する。
- 資産本体更新、属性20更新、1:n属性更新を単一トランザクションで処理する。
- 不変条件（3階層分類必須、業務制約）をServiceで検証する。

完了条件:
- View層でORM直接更新を行わない。
- 属性20と1:n属性の更新APIが正常系/異常系テストで保証される。
- 既存回帰（`apps.account_requests.tests`）が全件成功する。

---

### フェーズ2（P2）: 廃棄承認/棚卸 操作UI
対象画面:
- `templates/account_requests/disposal_approval.html`
- `templates/account_requests/inventory_list.html`

実装方針:
- 廃棄承認画面に承認/差戻し操作フォームと証跡入力欄を追加する。
- 棚卸画面に差異登録/是正更新フォームを追加する。
- 更新処理は既存Service/APIを利用し、テンプレートは入力と表示に専念させる。

完了条件:
- SCR-060（IV-003〜IV-005）、SCR-070（DP-004〜DP-006）の不足項目が入力可能。
- 画面操作の正常系（更新成功）と異常系（必須不足/不正値）がテストで確認できる。

---

### フェーズ3（P3）: 予算画面入力拡張
対象画面:
- `templates/account_requests/budget_list.html`

実装方針:
- 予算3階層分類（大/中/小）入力欄を追加する。
- 予算属性20（単一値）と1:n情報（複数行）入力を追加する。
- API設計（`docs/07_詳細設計_API設計.md`）に合わせて `attributes` / `multi_attributes` を送信する。

完了条件:
- SCR-030の不足項目（BG-002A/B/C, BG-A-01〜07, BG-M-001〜003）が入力可能。
- 予算登録/更新のテストが正常系・異常系で追加される。

---

### フェーズ4（P4）: 監査ログ検索 + ダッシュボード拡張
対象画面:
- `templates/account_requests/audit_logs.html`
- `templates/account_requests/dashboard.html`

実装方針:
- 監査ログに対象/操作/実行者/期間フィルタを追加する。
- ダッシュボードに予算消化率と保守期限アラート表示を追加する。
- 検索/集計はDB評価優先で実装し、不要な早期 `list()` 化を避ける。

完了条件:
- SCR-080（AL-001〜AL-005）、SCR-001（DS-001, DS-003）の不足表示が解消される。
- 性能劣化がないことを一覧系性能テスト観点で確認する。

## 4. 推奨実行順（短期スプリント）
- Sprint A: フェーズ1（API完成化）
- Sprint B: フェーズ2（運用操作UI）
- Sprint C: フェーズ3（予算入力拡張）
- Sprint D: フェーズ4（検索/可視化拡張）

## 5. 実装時のガードレール
- 3層責務（Interface -> Application -> Domain）を厳守する。
- Viewから直接DB更新しない。
- 状態遷移は既存の業務Serviceを経由する。
- 各フェーズで正常系/異常系テストを必ず追加する。

## 6. 最初の着手タスク（次アクション）
- フェーズ1着手として、`assets/{id}` 更新処理をService化し、属性20/1:n更新テストを先に追加する（TDD順）。
